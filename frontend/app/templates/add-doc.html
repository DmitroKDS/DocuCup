<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>DocuCup</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">

    <script src="{{ url_for('static', filename='config.js') }}"></script>
    
    <script src="{{ url_for('static', filename='lang.js') }}"></script>
</head>
<body>
    <header style="margin: 30px 30px 50px 30px; justify-content: space-between" class="flex">
        <div onclick="window.location.href='/home'" style="cursor: pointer; align-items: center;" class="main flex">
            <img style="width: 30px;" src="../static/images/logo.png">
            <p style="font-weight: bold; margin-left: 15px; font-size: 18px;">
                Docu
                <span style="font-size: 18px;color: var(--primary)">Cup</span>
            </p>
        </div>

        <div style="align-items: center;" class="main flex">
            <div style="padding: 6px; border: 2px solid var(--text); border-radius: 8px; margin-right: 20px; font-weight: bold" class="flex center">
                <span class="material-symbols-outlined" style="margin-right: 5px;">
                    toll
                </span>
                {{credits}} credits
            </div>
            <button class="border-button" onclick="document.location.href='/home'">Back</button>
        </div>
    </header>
    <div style="align-items: center" class="flex column" enctype="multipart/form-data" method="POST">
        <h1 style="font-weight: bold; font-size: 36px;">Upload document</h1>
        <div style="margin: 40px 0 0 0" class="input">
            <input name="party" type="text" placeholder=" " required>
            <label>Who are you in the document</label>
        </div>
        <div style="margin: 40px 0 0 0" class="input">
            <input class="title" name="title" type="text" placeholder=" " required>
            <label>Title</label>
        </div>
        <div style="margin: 20px 0 40px 0;" class="file-input flex center column">
            <h4>Select document here</h4>
            <p>Available formats: PDF, TEXT, DOCX</p>
            <input type="file" hidden accept=".txt,.docx,.pdf" name="doc" onchange="uploadDoc(this)" required>
            <button class="border-button" type="button" onclick="this.parentElement.querySelector('input').click()">Upload document</button>
            <h3>or</h3>
            <button class="border-button" type="button" onclick="addBufferDoc()">Upload text from clipboard</button>
        </div>
        <button class="primary-button" onclick="creditsDoc()">Continue</button>
    </div>


    <div class="flex center hidden banner" style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.5)">
        <div class="flex center column between" style="padding: 50px 10px 40px 10px; width: 460px; height: 190px; background-color: #fff; border-radius: 12px;">
            <h1 style="font-size: 24px; text-align: center;">Document is being created.<br>Please wait until AI will have proccessed your document</h1>
        </div>
    </div>

    <div class="flex center hidden warn-banner" style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.5)">
        <div class="flex center column between" style="padding: 50px 10px 40px 10px; width: 460px; height: 190px; background-color: #fff; border-radius: 12px;">
            <h1 style="font-size: 24px; text-align: center;">Something went wrong.</h1>
            <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="primary-button">Ok</button>
        </div>
    </div>

    <div class="flex center hidden accept-banner" style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.5)">
        <div class="flex center column between" style="padding: 50px 10px 40px 10px; width: 460px; height: 190px; background-color: #fff; border-radius: 12px;">
            <h1 style="font-size: 24px; text-align: center;"></h1>
            <div class="flex" style="gap: 20px;">
                <button onclick="this.parentElement.parentElement.parentElement.classList.add('hidden');" class="border-button">Cancel</button>
                <button onclick="this.parentElement.parentElement.parentElement.classList.add('hidden'); addDoc();" class="primary-button">Ok</button>
            </div>
        </div>
    </div>

    <div id="output"></div>


    <script>
        translatePage()


        function uploadDoc(doc) {
            doc.parentElement.querySelector('h4').innerText = doc.files[0].name;
            document.querySelector('.title').value = doc.files[0].name.replace(".docx", "").replace(".pdf", "").replace(".txt", "");
        }

        function checkDoc() {
            let party = document.getElementsByName('party')[0].value;
            let title = document.getElementsByName('title')[0].value;
            let doc = document.getElementsByName('doc')[0].files;
            
            let warn;
            
            if (party.trim() == "") {
                warn = `You didn't write - 'Who are you in the document'`;
            } else if (title.trim() == ""){
                warn = `You didn't write title`;
            } else if (doc.length == 0){
                warn = `You didn't select document`;
            }
            
            if (party.trim() == "" || title.trim() == "" || doc.length == 0) {
                document.querySelector('.banner').classList.add("hidden");
                document.querySelector('.warn-banner').classList.remove("hidden");
                document.querySelector('.warn-banner').querySelector("h1").innerText = lang[warn]?.[langCode] ?? warn;
                return;
            }


            doc=doc[0]

            return [party, title, doc];
        }

        function creditsDoc() {
            let result = checkDoc();
            if (!result) return;
            let [party, title, doc] = result;

            let formData = new FormData();
            formData.append("doc", doc);      

            fetch(`${hostUrl}/add-doc/credits`, {method: "POST", body: formData})
            .then(response => response.json())
            .then(data => {
                if (data.warn) {
                    console.log(data.warn);
                    document.querySelector('.warn-banner').classList.remove("hidden");
                    document.querySelector('.warn-banner').querySelector("h1").innerText = lang[data.warn]?.[langCode] ?? data.warn
                } else {
                    document.querySelector('.accept-banner').classList.remove("hidden");
                    let acceptText = ["Adding a document will cost", "credits"]
                    let text = `${lang[acceptText[0]]?.[langCode] ?? acceptText[0]} <span style="font-size: 24px; color: var(--button-primary)">${data.credits}</span> ${lang[acceptText[1]]?.[langCode] ?? acceptText[1]}`;
                    document.querySelector('.accept-banner').querySelector("h1").innerHTML = text;
                }
            })
            .catch(error => {
                console.log(error);
                document.querySelector('.banner').classList.add("hidden");
                document.querySelector('.warn-banner').classList.remove("hidden");

                let warnText = `Something went wrong.`
                document.querySelector('.warn-banner').querySelector("h1").innerText = lang[warnText]?.[langCode] ?? warnText
            });
        }

        function addDoc() {
            document.querySelector('.banner').classList.remove("hidden");
            
            let result = checkDoc();
            if (!result) return;
            let [party, title, doc] = result;

            let formData = new FormData();
            formData.append("title", title);
            formData.append("doc", doc);  
            formData.append("party", party);      

            fetch(`${hostUrl}/add-doc/`, {method: "POST", body: formData})
            .then(response => {console.log(response); return response.json()})
            .then(data => {
                console.log(data);
                if (data.warn) {
                    console.log(data.warn);
                    document.querySelector('.banner').classList.add("hidden");
                    document.querySelector('.warn-banner').classList.remove("hidden");

                    document.querySelector('.warn-banner').querySelector("h1").innerText = lang[data.warn]?.[langCode] ?? data.warn
                } else {
                    document.querySelector('.banner').classList.add("hidden");
                    window.location.href = `/home/${data.id}`;
                }
            })
            .catch(error => {
                console.log(error);
                document.querySelector('.banner').classList.add("hidden");
                document.querySelector('.warn-banner').classList.remove("hidden");

                let warnText = `Something went wrong.`
                document.querySelector('.warn-banner').querySelector("h1").innerText = lang[warnText]?.[langCode] ?? warnText
            });
        }

        async function addBufferDoc() {
            let bufferText = await navigator.clipboard.readText();

            
            let file = new File([bufferText], "document.txt", { type: "text/plain" });
      
            let dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
      
            document.getElementsByName("doc")[0].files = dataTransfer.files;
            uploadDoc(document.getElementsByName("doc")[0])
        }
    </script>
</body>
</html>

            